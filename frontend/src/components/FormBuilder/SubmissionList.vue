<template>
    <div class="p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">ูุงุฆูุฉ ุงูุทูุจุงุช</h2>
            <!-- <button v-if="route.params.formId" class="btn btn-primary" @click="goToNew">โ ุทูุจ ุฌุฏูุฏ</button> -->
        </div>
        <!-- โ ุดุฑูุท ุฃุฏูุงุช ุงูุจุญุซ ูุงูุชููู (ูููุดุฑู ููุท) -->
        <div v-if="is_staff" class="mb-6 space-y-4">
            <!-- ๐ ุดุฑูุท ุงูุจุญุซ -->
            <input v-model="searchTerm" @input="fetchSubmissions" type="text" placeholder="ุงุจุญุซ ุจุฑูู ุงูุทุงูุจ ุฃู ุงูุทูุจ..."
                class="w-full px-4 py-2 border rounded shadow-sm" />
            <div class="flex flex-wrap gap-4 items-center">
                <!-- ููุชุฑ ุงูุญุงูุฉ -->
                <select v-model="selectedStatus" @change="fetchSubmissions" class="border px-3 py-1 rounded shadow-sm">
                    <option value="">ูู ุงูุญุงูุงุช</option>
                    <option value="reviewed">ูุณุชููู</option>
                    <option value="pending">ุชุญุช ุงููุฑุงุฌุนุฉ</option>
                    <option value="accepted">ุชู ุงููุจูู</option>
                    <option value="rejected">ุชู ุงูุฑูุถ</option>
                    <option value="noted">ุชูุฌุฏ ููุงุญุธุงุช</option>
                </select>

                <!-- ููุชุฑ ุงูุฅุบูุงู -->
                <select v-model="selectedLock" @change="fetchSubmissions" class="border px-3 py-1 rounded shadow-sm">
                    <option value="">ุงููู (ููุชูุญ ููุบูู)</option>
                    <option :value="true">๐ ูุบูู</option>
                    <option :value="false">โ ููุชูุญ</option>
                </select>
                <!-- ููุชุฑ ุงูุฏูุน -->
                <select v-model="selectedPaid" @change="fetchSubmissions" class="border px-3 py-1 rounded shadow-sm">
                    <option value="">ุงููู (ูุฏููุน ูุบูุฑ ูุฏููุน)</option>
                    <option :value="true">๐ฐ ูุฏููุน</option>
                    <option :value="false">๐ซ ุบูุฑ ูุฏููุน</option>
                </select>
                <!-- ุฒุฑ ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุชุฑ -->
                <button @click="resetFilters" class="btn bg-gray-200 text-gray-800 hover:bg-gray-300">
                    ๐ ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุชุฑ
                </button>
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <div v-for="(qa, index) in qaFilters" :key="index" class="flex gap-2 items-center">
                        <!-- ุญูู ุงูุณุคุงู -->
                        <select v-model="qa.question" @change="qa.answer = ''; fetchSubmissions()"
                            class="border px-3 py-1 rounded shadow-sm">
                            <option value="">-- ุงุฎุชุฑ ุณุคุงู --</option>
                            <option v-for="q in uniqueQA" :key="q.question_title" :value="q.question_title">
                                {{ q.question_title }}
                            </option>
                        </select>

                        <!-- ุญูู ุงูุฅุฌุงุจุฉ -->
                        <div class="flex items-center gap-1">
                            <template v-if="qa.editingAnswer">
                                <input type="text" v-model="qa.answer" class="border px-3 py-1 rounded shadow-sm"
                                    placeholder="ุฃุฏุฎู ูุต ุงูุฅุฌุงุจุฉ" />
                                <button @click="confirmManualAnswer(qa)"
                                    class="text-green-600 hover:text-green-800 text-lg">โ๏ธ</button>
                            </template>
                            <template v-else>
                                <select v-if="qa.question" v-model="qa.answer" @change="fetchSubmissions()"
                                    class="border px-3 py-1 rounded shadow-sm">
                                    <option value="">-- ุงุฎุชุฑ ุฅุฌุงุจุฉ --</option>
                                    <option
                                        v-for="a in (uniqueQA.find(x => x.question_title === qa.question)?.answers || [])"
                                        :key="a" :value="a">
                                        {{ a }}
                                    </option>
                                </select>
                                <button v-if="qa.question" @click="qa.editingAnswer = true"
                                    class="text-sm text-blue-600 hover:underline">โ ุงุถู ุงุฎุชูุงุฑ</button>
                            </template>
                        </div>

                        <!-- ุฒุฑ ุญุฐู ุงูููุชุฑ -->
                        <button v-if="qaFilters.length > 1" @click="qaFilters.splice(index, 1); fetchSubmissions()"
                            class="text-red-500 hover:text-red-700 text-lg">&times;</button>
                    </div>

                    <button class="btn mt-2" @click="addQAFilter">โ ุฅุถุงูุฉ ููุชุฑ ุณุคุงู</button>
                </div>




            </div>

            <!-- โ Pagination ุฏููุงูููู -->
            <div v-if="totalPages > 1" class="mt-6 flex flex-wrap justify-center gap-2 items-center text-sm">
                <button class="btn" :disabled="currentPage == 1" @click="currentPage = 1; fetchSubmissions();">
                    ุงูุฃููู
                </button>
                <!-- ุงูุณุงุจู -->
                <button class="btn" :disabled="currentPage <= 1" @click="currentPage--; fetchSubmissions();">
                    โฌ๏ธ ุงูุณุงุจู
                </button>

                <!-- ุงูุตูุญุงุช -->
                <button v-for="page in paginationPages" :key="page" class="px-3 py-1 rounded border"
                    :class="page === currentPage ? 'bg-blue-600 text-white' : 'bg-white'"
                    @click="currentPage = page; fetchSubmissions();">
                    {{ page }}
                </button>

                <!-- ุงูุชุงูู -->
                <button class="btn" :disabled="currentPage >= totalPages" @click="currentPage++; fetchSubmissions();">
                    ุงูุชุงูู โก๏ธ
                </button>

                <!-- ุงูุฃุฎูุฑุฉ -->
                <button class="btn" v-if="currentPage < totalPages"
                    @click="currentPage = totalPages; fetchSubmissions();">
                    ุงูุฃุฎูุฑุฉ
                </button>
            </div>

        </div>

        <div v-if="is_staff && totalCount > 0" class="text-sm text-gray-500 mb-2">
            ุนุฑุถ ูู {{ (currentPage - 1) * 20 + 1 }}
            ุฅูู {{ Math.min(currentPage * 20, totalCount) }}
            ูู ุฅุฌูุงูู {{ totalCount }} ุณุฌู
        </div>


        <div v-if="loading" class="text-gray-500">ุฌุงุฑู ุงูุชุญููู...</div>

        <div v-else class="space-y-3">
            <div v-for="submission in submissions" :key="submission.id" class="p-4 bg-white border rounded shadow ">
                <!-- โ ูุนูููุงุช ุงูุทูุจ -->
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">

                    <div class="w-full md:w-auto">
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <!-- ุฑูู ุงูุทูุจ -->
                            <div @click="goToView(submission.form, submission.id)"
                                class="text-lg font-semibold cursor-pointer">
                                ุทูุจ ุฑูู #{{ submission.id }}
                            </div>

                            <!-- ุฑูู ุงูุทุงูุจ -->
                            <div @click="goToView(submission.form, submission.id)"
                                class="text-lg font-semibold cursor-pointer">
                                ุงูุทุงูุจ #{{ submission.user_identifier }}
                            </div>

                            <!-- โ ุงูุญุงูุฉ -->
                            <div class="flex flex-col md:flex-row md:items-center text-sm text-gray-500 gap-2 md:gap-4">
                                <span class="font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded"
                                    :class="'status-' + submission.status">
                                    ุงูุญุงูุฉ: {{ getStatusLabel(submission.status) }}
                                </span>

                                <!-- โ ุฅุดุงุฑุฉ ุงูุฏูุน -->
                                <span v-if="submission.is_paied"
                                    class="font-bold text-green-700 bg-green-100 px-2 py-1 rounded">
                                    ๐ฐ ุชู ุงูุฏูุน
                                </span>

                                <!-- โ ุงุฎุชูุงุฑ ุงูุญุงูุฉ -->
                                <select v-if="is_staff" v-model="submission.status"
                                    class="text-sm px-2 py-1 rounded border" :class="'status-' + submission.status"
                                    @change="updateStatus(submission)">
                                    <option value="reviewed">ูุณุชููู</option>
                                    <option value="pending">ุชุญุช ุงููุฑุงุฌุนุฉ</option>
                                    <option value="accepted">ุชู ุงููุจูู</option>
                                    <option value="rejected">ุชู ุงูุฑูุถ</option>
                                    <option value="noted">ุชูุฌุฏ ููุงุญุธุงุช</option>
                                </select>

                                <!-- โ ููุงุญุธุงุช -->

                                <button v-if="is_staff" @click="openNoteModal(submission)"
                                    class="text-sm px-2 py-1 bg-gray-100 rounded" :class="'status-noted'">
                                    ๐ </button>

                                <!-- โ ุขุฎุฑ ุชุญุฏูุซ -->
                                <span class="text-xs text-gray-400">
                                    ุขุฎุฑ ุชุญุฏูุซ: {{ formatDate(submission.modified_at) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- โ ุฃุฒุฑุงุฑ ุงูุฅุฏุงุฑุฉ -->
                    <div class="flex gap-3 text-xl items-center md:justify-end w-full md:w-auto">
                        <button v-if="is_staff" @click="toggleActive(submission)"
                            :title="submission.is_locked ? 'ูุชุญ' : 'ุบูู'">
                            <span v-if="submission.is_locked">๐๏ธ</span>
                            <span v-else>๐</span>
                        </button>

                        <button @click="goToView(submission.form, submission.id)" title="ุนุฑุถ">๐๏ธ</button>

                        <button v-if="is_staff || (!is_staff && !submission.is_locked)"
                            @click="goToEdit(submission.form, submission.id)" title="ุชุนุฏูู">โ๏ธ</button>
                        <button v-if="is_staff || (!is_staff && !submission.is_locked)"
                            @click="set_user_password(submission.user_identifier)"
                            title="ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ">๐</button>

                        <button v-if="is_superadmin" @click="deleteSubmission(submission.id)" title="ุญุฐู">๐๏ธ</button>
                    </div>
                </div>
                <!-- โ ุนุฑุถ ุงูููุงุญุธุฉ ูู ููุฌูุฏุฉ -->
                <div v-if="submission.notes"
                    class="w-full mt-2 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-900 p-3 text-sm rounded">
                    ๐ <span class="font-semibold">ููุงุญุธุฉ:</span> {{ submission.notes }}
                </div>

                <!-- โ ุงูููุฏุงู -->

                <Dialog v-model:visible="visible" modal header="ุงุถุงูุฉ ููุงุญุธุฉ" :style="{ width: '25rem' }">
                    <span class="text-surface-500 dark:text-surface-400 block mb-8">ุงุถู ููุงุญุธุฉ ููุทูุจ ุฑูู {{
                        submission.id }}</span>
                    <div class="flex items-center gap-4 mb-4">
                        <label for="note" class="font-semibold w-24">ุงูููุงุญุธุฉ</label>
                        <Textarea v-model="noteContent" rows="5" cols="30" id="note" class="flex-auto"
                            autocomplete="off" />
                    </div>

                    <div class="flex justify-end gap-2">
                        <Button type="button" label="ุงูุบุงุก" severity="secondary" @click="visible = false"></Button>
                        <Button type="button" label="ุญูุธ" @click="saveNote"></Button>
                    </div>
                </Dialog>
            </div>
        </div>


    </div>
</template>

<script setup>
import { ref, onMounted, computed, watch } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import axios from '@/services/axios';
const uniqueQA = ref([])
const qaFilters = ref([{ question: '', answer: '' }])

const currentPage = ref(1)
const searchTerm = ref('')
const selectedStatus = ref('')
const selectedLock = ref('')
const selectedPaid = ref('')


const totalPages = ref(1)
const totalCount = ref(0)
const paginationPages = computed(() => {
    const pages = []
    const maxVisible = 5
    const start = Math.max(1, currentPage.value - 2)
    const end = Math.min(totalPages.value, start + maxVisible - 1)

    for (let i = start; i <= end; i++) {
        pages.push(i)
    }
    return pages
})

const fetchUniqueQuestionsAndAnswers = async () => {
    try {
        const res = await axios.get(`/api/admissions/forms/${route.params.formId}/unique-questions-answers/`)
        uniqueQA.value = res.data.map(qa => ({
            ...qa,
            editing: false // ูุถุน ุชุญุฑูุฑ ุงูุชุฑุงุถู
        }))
    } catch (error) {
        console.error('Error fetching unique Q&A:', error)
    }
}
const confirmManualAnswer = (qa) => {
    qa.editingAnswer = false;

    if (!qa.question || !qa.answer) return;

    const question = uniqueQA.value.find(x => x.question_title === qa.question);
    if (question && !question.answers.includes(qa.answer)) {
        question.answers.push(qa.answer); // ุฃุถููุง ูุคูุชูุง ุฅูู ุงููุงุฆูุฉ
    }

    fetchSubmissions();
};

const addQAFilter = () => {
    qaFilters.value.push({ question: '', answer: '' })
}
const router = useRouter();
const route = useRoute();
const submissions = ref([]);
const forms = ref([]);
const loading = ref(true);
const showNoteModal = ref(false);
const noteContent = ref('');
const selectedSubmission = ref(null);
const visible = ref(false);
const resetFilters = () => {
    searchTerm.value = ''
    selectedStatus.value = ''
    selectedLock.value = ''
    selectedPaid.value = ''
    qaFilters.value = []
    currentPage.value = 1
    fetchSubmissions()
}
const STORAGE_KEY = 'submissions_filters'


const openNoteModal = (submission) => {
    selectedSubmission.value = submission;
    noteContent.value = submission.notes || '';
    showNoteModal.value = true;
    visible.value = true;
};

const saveNote = async () => {
    if (!selectedSubmission.value) return;
    try {
        await axios.patch(`api/admissions/submissions/${selectedSubmission.value.id}/`, {
            notes: noteContent.value,
        });
        selectedSubmission.value.notes = noteContent.value;
        showNoteModal.value = false;
        visible.value = false
    } catch (err) {

        alert('ูุดู ุญูุธ ุงูููุงุญุธุงุช');
    }
};
const set_user_password = async (user_identifier) => {
    if (!user_identifier) return;
    try {
        const res = await axios.post(`api/users/set_user_password/`, {
            username: user_identifier,
            password: user_identifier,
        });

        // console.log(res.data) ๐๏ธ
        const success = res.data.success
        if (success) { alert("ุชู ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ"); }
        const error = res.data.error
        if (error) { alert('ูุดู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ'); }
    } catch (err) {
        console.error(err)
        alert('ูุดู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ');
    }
};

const updateStatus = async (submission) => {
    try {
        await axios.patch(`api/admissions/submissions/${submission.id}/`, {
            status: submission.status,
        });
    } catch (err) {
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุญุงูุฉ');
    }
};

const getStatusLabel = (status) => {
    return (
        {
            pending: 'ุชุญุช ุงููุฑุงุฌุนุฉ',
            accepted: 'ุชู ุงููุจูู',
            rejected: 'ุชู ุงูุฑูุถ',
            reviewed: 'ูุณุชููู',
            noted: 'ุชูุฌุฏ ููุงุญุธุงุช',
        }[status] || 'ุบูุฑ ูุนุฑูู'
    );
};

const is_staff = computed(() => {
    const is_staff2 = JSON.parse(localStorage.getItem('user_is_staff'));
    return is_staff2;
});
const is_superadmin = computed(() => {
    const is_superadmin = localStorage.getItem('user_username') === 'ibrahim';
    return is_superadmin;
});


const fetchSubmissions = async () => {
    loading.value = true
    try {
        const params = {
            page: currentPage.value,
            search: is_staff.value ? searchTerm.value : undefined,
            form: route.params.formId || undefined,
            status: selectedStatus.value || undefined,
            is_locked: selectedLock.value !== '' ? selectedLock.value : undefined,
            is_paied: selectedPaid.value !== '' ? selectedPaid.value : undefined,



        }
        // โ ุฃุถู ูู ููุชุฑ ุณุคุงู/ุฅุฌุงุจุฉ ูู params
        qaFilters.value.forEach((qa, index) => {
            if (index === 0) {
                if (qa.question) params['question_title'] = qa.question
                if (qa.answer) params['answer_text'] = qa.answer
            } else {
                if (qa.question) params[`question_title_${index}`] = qa.question
                if (qa.answer) params[`answer_text_${index}`] = qa.answer
            }
        })
        const res = await axios.get(`api/admissions/submissions-list/`, { params })

        submissions.value = res.data.results
        totalCount.value = res.data.count
        totalPages.value = Math.ceil(res.data.count / 20)
    } catch (error) {
        console.error('Error loading submissions:', error)
    } finally {
        loading.value = false
    }
}


const goToNew = () => router.push(`/submissions/${route.params.formId}/new`);
const goToEdit = (form_id, id) => router.push(`/submissions/${form_id}/${id}/edit`);
const goToView = (form_id, id) => router.push(`/submissions/${form_id}/${id}`);

const deleteSubmission = async (id) => {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุทูุจุ')) return;
    try {
        await axios.delete(`api/admissions/submissions/${id}/`);
        await fetchSubmissions();
    } catch (error) {
        alert('ูุง ูููู ุญุฐู ุงูุทูุจ.');
    }
};
const toggleActive = async (submission) => {
    try {
        const res = await axios.patch(`api/admissions/submissions/${submission.id}/`, {
            is_locked: !submission.is_locked,
        });
        submission.is_locked = res.data.is_locked;
    } catch (error) {
        console.error('Error toggling active state:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุนุฏูู ุญุงูุฉ ุงููููุฐุฌ.');
    }
};
const formatDate = (dateStr) => {
    // console.log(dateStr);
    if (!dateStr) return '';
    const [datePart, timePart] = dateStr.split(' ');
    const [year, month, day] = datePart.split('-');
    const [hour, minute] = timePart.split(':');
    const date = new Date(year, month - 1, day, hour, minute);

    return date.toLocaleString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    });
};

onMounted(() => {
    fetchUniqueQuestionsAndAnswers()
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}')

    searchTerm.value = saved.searchTerm || ''
    selectedStatus.value = saved.selectedStatus || ''
    selectedLock.value = saved.selectedLock ?? ''
    selectedPaid.value = saved.selectedPaid ?? ''
    qaFilters.value = saved.qaFilters ?? []
    currentPage.value = saved.currentPage || 1

    fetchSubmissions()

})

watch(
    [searchTerm, selectedStatus, selectedLock, selectedPaid, qaFilters, currentPage],
    () => {
        localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
                searchTerm: searchTerm.value,
                selectedStatus: selectedStatus.value,
                selectedLock: selectedLock.value,
                selectedPaid: selectedPaid.value,
                qaFilters: qaFilters.value,
                currentPage: currentPage.value,
            })
        )
    },
    { deep: true }
)

</script>

<style scoped>
.btn {
    @apply bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700;
}

.status-pending {
    @apply bg-blue-100 text-blue-800 px-2 py-1 rounded;
}

.status-accepted {
    @apply bg-green-100 text-green-800 px-2 py-1 rounded;
}

.status-rejected {
    @apply bg-red-100 text-red-800 px-2 py-1 rounded;
}

.status-reviewed {
    @apply bg-green-100 text-green-800 px-2 py-1 rounded;
}

.status-noted {
    @apply bg-yellow-100 text-yellow-800 px-2 py-1 rounded;
}

.status-noted {
    @apply bg-yellow-100 text-yellow-800 px-2 py-1 rounded;
}
.status-noted {
    @apply bg-yellow-100 text-yellow-800 px-2 py-1 rounded;
}
.status-noted {
    @apply bg-yellow-100 text-yellow-800 px-2 py-1 rounded;
}
</style>
